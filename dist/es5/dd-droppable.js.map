{"version":3,"file":"dd-droppable.js","sourceRoot":"","sources":["../../src/dd-droppable.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * dd-droppable.ts 7.3.0\r\n * Copyright (c) 2021-2022 Alain Dumesny - see GridStack root license\r\n */\r\n\r\nimport { DDDraggable } from './dd-draggable';\r\nimport { DDManager } from './dd-manager';\r\nimport { DDBaseImplement, HTMLElementExtendOpt } from './dd-base-impl';\r\nimport { Utils } from './utils';\r\nimport { DDElementHost } from './dd-element';\r\nimport { isTouch, pointerenter, pointerleave } from './dd-touch';\r\nimport { DDUIData } from './types';\r\n\r\nexport interface DDDroppableOpt {\r\n  accept?: string | ((el: HTMLElement) => boolean);\r\n  drop?: (event: DragEvent, ui: DDUIData) => void;\r\n  over?: (event: DragEvent, ui: DDUIData) => void;\r\n  out?: (event: DragEvent, ui: DDUIData) => void;\r\n}\r\n\r\n// let count = 0; // TEST\r\n\r\nexport class DDDroppable extends DDBaseImplement implements HTMLElementExtendOpt<DDDroppableOpt> {\r\n\r\n  public accept: (el: HTMLElement) => boolean;\r\n  public el: HTMLElement;\r\n  public option: DDDroppableOpt;\r\n\r\n  constructor(el: HTMLElement, opts: DDDroppableOpt = {}) {\r\n    super();\r\n    this.el = el;\r\n    this.option = opts;\r\n    // create var event binding so we can easily remove and still look like TS methods (unlike anonymous functions)\r\n    this._mouseEnter = this._mouseEnter.bind(this);\r\n    this._mouseLeave = this._mouseLeave.bind(this);\r\n    this.enable();\r\n    this._setupAccept();\r\n  }\r\n\r\n  public on(event: 'drop' | 'dropover' | 'dropout', callback: (event: DragEvent) => void): void {\r\n    super.on(event, callback);\r\n  }\r\n\r\n  public off(event: 'drop' | 'dropover' | 'dropout'): void {\r\n    super.off(event);\r\n  }\r\n\r\n  public enable(): void {\r\n    if (this.disabled === false) return;\r\n    super.enable();\r\n    this.el.classList.add('ui-droppable');\r\n    this.el.classList.remove('ui-droppable-disabled');\r\n    this.el.addEventListener('mouseenter', this._mouseEnter);\r\n    this.el.addEventListener('mouseleave', this._mouseLeave);\r\n    if (isTouch) {\r\n      this.el.addEventListener('pointerenter', pointerenter);\r\n      this.el.addEventListener('pointerleave', pointerleave);\r\n    }\r\n  }\r\n\r\n  public disable(forDestroy = false): void {\r\n    if (this.disabled === true) return;\r\n    super.disable();\r\n    this.el.classList.remove('ui-droppable');\r\n    if (!forDestroy) this.el.classList.add('ui-droppable-disabled');\r\n    this.el.removeEventListener('mouseenter', this._mouseEnter);\r\n    this.el.removeEventListener('mouseleave', this._mouseLeave);\r\n    if (isTouch) {\r\n      this.el.removeEventListener('pointerenter', pointerenter);\r\n      this.el.removeEventListener('pointerleave', pointerleave);\r\n    }\r\n  }\r\n\r\n  public destroy(): void {\r\n    this.disable(true);\r\n    this.el.classList.remove('ui-droppable');\r\n    this.el.classList.remove('ui-droppable-disabled');\r\n    super.destroy();\r\n  }\r\n\r\n  public updateOption(opts: DDDroppableOpt): DDDroppable {\r\n    Object.keys(opts).forEach(key => this.option[key] = opts[key]);\r\n    this._setupAccept();\r\n    return this;\r\n  }\r\n\r\n  /** @internal called when the cursor enters our area - prepare for a possible drop and track leaving */\r\n  protected _mouseEnter(e: MouseEvent): void {\r\n    // console.log(`${count++} Enter ${this.el.id || (this.el as GridHTMLElement).gridstack.opts.id}`); // TEST\r\n    if (!DDManager.dragElement) return;\r\n    if (!this._canDrop(DDManager.dragElement.el)) return;\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n\r\n    // make sure when we enter this, that the last one gets a leave FIRST to correctly cleanup as we don't always do\r\n    if (DDManager.dropElement && DDManager.dropElement !== this) {\r\n      DDManager.dropElement._mouseLeave(e as DragEvent);\r\n    }\r\n    DDManager.dropElement = this;\r\n\r\n    const ev = Utils.initEvent<DragEvent>(e, { target: this.el, type: 'dropover' });\r\n    if (this.option.over) {\r\n      this.option.over(ev, this._ui(DDManager.dragElement))\r\n    }\r\n    this.triggerEvent('dropover', ev);\r\n    this.el.classList.add('ui-droppable-over');\r\n    // console.log('tracking'); // TEST\r\n  }\r\n\r\n  /** @internal called when the item is leaving our area, stop tracking if we had moving item */\r\n  protected _mouseLeave(e: MouseEvent): void {\r\n    // console.log(`${count++} Leave ${this.el.id || (this.el as GridHTMLElement).gridstack.opts.id}`); // TEST\r\n    if (!DDManager.dragElement || DDManager.dropElement !== this) return;\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n\r\n    const ev = Utils.initEvent<DragEvent>(e, { target: this.el, type: 'dropout' });\r\n    if (this.option.out) {\r\n      this.option.out(ev, this._ui(DDManager.dragElement))\r\n    }\r\n    this.triggerEvent('dropout', ev);\r\n\r\n    if (DDManager.dropElement === this) {\r\n      delete DDManager.dropElement;\r\n      // console.log('not tracking'); // TEST\r\n\r\n      // if we're still over a parent droppable, send it an enter as we don't get one from leaving nested children\r\n      let parentDrop: DDDroppable;\r\n      let parent: DDElementHost = this.el.parentElement;\r\n      while (!parentDrop && parent) {\r\n        parentDrop = parent.ddElement?.ddDroppable;\r\n        parent = parent.parentElement;\r\n      }\r\n      if (parentDrop) {\r\n        parentDrop._mouseEnter(e);\r\n      }\r\n    }\r\n  }\r\n\r\n  /** item is being dropped on us - called by the drag mouseup handler - this calls the client drop event */\r\n  public drop(e: MouseEvent): void {\r\n    e.preventDefault();\r\n    const ev = Utils.initEvent<DragEvent>(e, { target: this.el, type: 'drop' });\r\n    if (this.option.drop) {\r\n      this.option.drop(ev, this._ui(DDManager.dragElement))\r\n    }\r\n    this.triggerEvent('drop', ev);\r\n  }\r\n\r\n  /** @internal true if element matches the string/method accept option */\r\n  protected _canDrop(el: HTMLElement): boolean {\r\n    return el && (!this.accept || this.accept(el));\r\n  }\r\n\r\n  /** @internal */\r\n  protected _setupAccept(): DDDroppable {\r\n    if (!this.option.accept) return this;\r\n    if (typeof this.option.accept === 'string') {\r\n      this.accept = (el: HTMLElement) => el.matches(this.option.accept as string);\r\n    } else {\r\n      this.accept = this.option.accept;\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /** @internal */\r\n  protected _ui(drag: DDDraggable): DDUIData {\r\n    return {\r\n      draggable: drag.el,\r\n      ...drag.ui()\r\n    };\r\n  }\r\n}\r\n\r\n"]}